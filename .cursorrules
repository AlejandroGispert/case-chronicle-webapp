# Case Chronicles â€“ Project Rules & Requirements (.cursorrules)

## ğŸ—ï¸ Architecture Pattern: MVC (Model-View-Controller)

**CRITICAL:** This project follows strict MVC architecture. Always maintain this pattern.

- **Models** (`src/backend/models/`)
  - Data access layer
  - Uses service abstractions only
- **Controllers** (`src/backend/controllers/`)
  - Business logic & authorization
- **Views** (`src/pages/`, `src/components/`)
  - React UI components

**RULES:**

- Views MUST call controllers
- Controllers call models
- Models NEVER call controllers or views
- Views MUST NEVER call models directly

---

## ğŸ”Œ Service Abstraction Layer (MIGRATION-READY)

**CRITICAL:** Never use Supabase client directly outside service adapters.

### Mandatory Service Factories

- `getDatabaseService()` â€“ all database operations
- `getStorageService()` â€“ all file storage operations
- `getAuthService()` â€“ all authentication operations

### Location

src/backend/services/
â”œâ”€â”€ database.types.ts
â”œâ”€â”€ storage.types.ts
â”œâ”€â”€ auth.types.ts
â”œâ”€â”€ database.supabase.ts
â”œâ”€â”€ storage.supabase.ts
â”œâ”€â”€ auth.supabase.ts
â””â”€â”€ index.ts

### Example

```ts
// âœ… CORRECT
import { getDatabaseService } from "../services";

const db = getDatabaseService();
const { data } = await db.from<MyType>("table").select("*").execute();

// âŒ FORBIDDEN
import { supabase } from "@/integrations/supabase/client";
await supabase.from("table").select("*");
```

---

## ğŸ§  Authorization & Access Control (MANDATORY)

**Authentication â‰  Authorization**

- Authorization decisions happen ONLY in controllers
- Never rely solely on RLS for business logic
- Every controller must explicitly enforce access control

### Required Helpers

**Location:** `src/backend/auth/authorization.ts`

- `requireAuth(user)`
- `requireRole(user, 'admin')`
- `requireOwnership(resourceUserId, user.id)`

Controllers MUST call these helpers before sensitive actions.

ğŸ§¾ Audit Logging (ISO 27001 / GDPR)
All sensitive operations MUST be audit-logged.

Log Events
Login / logout

Data create / update / delete

Permission changes

File upload / download

Data export / deletion (GDPR)

### Rules

- Logs are append-only
- Logs contain NO PII
- Logs include:
  - `user_id`
  - `action`
  - `resource_id`
  - `timestamp`
  - `request_id` / IP (if available)

**Location:** `src/backend/audit/`

---

## ğŸ“ Code Patterns

Model Pattern
import { getDatabaseService, getAuthService } from '../services';

export const myModel = {
async getItems() {
const auth = getAuthService();
const { user } = await auth.getUser();
if (!user) return [];

    const db = getDatabaseService();
    const { data, error } = await db
      .from<ItemType>('table')
      .select('*')
      .eq('user_id', user.id)
      .execute();

    if (error) {
      console.error(error);
      return [];
    }

    return data ?? [];

}
};

````

### Controller Pattern

```ts
import { myModel } from '../models/myModel';
import { requireAuth } from '../auth/authorization';

export const myController = {
  async fetchItems(user) {
    requireAuth(user);
    return myModel.getItems();
  }
};
````

### View Pattern

```ts
import { myController } from "@/backend/controllers/myController";

const MyComponent = () => {
  useEffect(() => {
    myController.fetchItems();
  }, []);
};
```

---

## ğŸš« Forbidden Anti-Patterns

âŒ Direct Supabase imports outside service adapters

âŒ Views calling models

âŒ Business logic in RLS

âŒ Supabase-only APIs without abstraction

âŒ Auth logic in UI components

âŒ Storing secrets in code

âŒ Logging PII

ğŸ“ File Organization
src/
â”œâ”€â”€ backend/
â”‚ â”œâ”€â”€ services/
â”‚ â”œâ”€â”€ models/
â”‚ â”œâ”€â”€ controllers/
â”‚ â”œâ”€â”€ auth/
â”‚ â”œâ”€â”€ audit/
â”‚ â””â”€â”€ utils/
â”œâ”€â”€ components/
â”œâ”€â”€ pages/
â”œâ”€â”€ contexts/
â””â”€â”€ integrations/
ğŸ” Authentication Rules
All auth via authController

UI uses useAuth() only

Never call supabase.auth directly

Auth state is centralized

ğŸ—„ï¸ Database Rules
Always filter user-owned data by user_id

Controllers enforce authorization

Models NEVER trust frontend input

Use parameterized queries only

ğŸ“¦ Storage Rules
Use getStorageService() only

Buckets:

case_document

email_attachments

Verify authentication before access

No direct public URLs

ğŸ›¡ï¸ GDPR & Data Protection
Data minimization enforced

User data deletion supported:

Soft delete (default)

Hard delete (on request)

Data export endpoint REQUIRED (GDPR Art. 20)

Controllers MUST log:

Data exports

Data deletions

ğŸ” Secrets & Configuration
All secrets via environment variables

Separate configs for dev / staging / prod

.env files never committed

No secrets in frontend bundles

ğŸ’¾ Backups & Disaster Recovery
Database backups required

Restore procedure documented

Backups must be Postgres-compatible

Restore tested at least quarterly

ğŸ“Š Monitoring & Logging
Centralized error logging

No sensitive data in logs

Request IDs preferred

Production errors must be traceable

ğŸŒ Network & Transport Security
HTTPS enforced

Secure cookies only

SameSite=strict or lax

CORS explicitly configured

ğŸ§ª Testing Standards
Controllers unit-testable

Services mockable

No test depends directly on Supabase

Migration tests preferred for services

ğŸ“¦ Dependency Security
Lockfile committed

Dependencies reviewed regularly

Avoid unmaintained security/auth libs

ğŸ¯ Feature Development Rules
Create model (services only)

Create controller (authorization enforced)

Create view (controller only)

Never skip layers

## âœ… Pre-Commit Checklist

- [ ] No Supabase imports outside services
- [ ] Authorization enforced in controllers
- [ ] Audit logging added for sensitive actions
- [ ] No PII in logs
- [ ] Services used everywhere
- [ ] Types are correct
- [ ] Errors handled
- [ ] GDPR rules respected

---

## ğŸ”„ Migration Guarantee

**This codebase MUST remain backend-agnostic.**

To migrate:

1. Implement new service adapters
2. Update service factory
3. No controller, model, or view changes allowed

**This file is authoritative. Violations are bugs.**

---

## ğŸ§¾ Notion Feature & Work Tracking (Cursor Agent)

The Cursor agent MUST keep the following Notion pages in sync with ongoing work on this app:

- `FEATURES` â€“ high-level product features for this case management app
- `ROADMAP` â€“ upcoming milestones and planned work
- `TECH_DEBT` â€“ known technical debt items
- `BUG_BACKLOG` â€“ bugs and regressions

**Rules for the agent:**

- **Automatic capture from conversation**
  - When the user describes a new feature, roadmap item, tech-debt item, or bug in chat, the agent should:
    - Interpret the item (Title, Description, Status, Area)
    - Create or update a row in the corresponding Notion table
    - Use the canonical table shape: `Title | Status | Area | Description`
    - Confirm the change back to the user in a short summary.

- **Keep Notion as source of truth**
  - When asked about features, roadmap, tech debt, or bugs, the agent should:
    - Read from the corresponding Notion page first
    - Present concise summaries (bullets or markdown tables) based on those pages
    - Update Notion whenever the conversation materially changes the plan or status.

- **Non-intrusive reorganization**
  - Only perform large-scale normalization or restructuring of those pages (moving legacy bullets into tables, etc.) when the user explicitly asks (e.g. â€œreorganize the FEATURES page into the clean table formatâ€).
