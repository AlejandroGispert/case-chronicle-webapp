openapi: 3.0.3
info:
  title: Case Chronicles API
  description: |
    REST API for Case Chronicles. All operations that modify or return user data require a valid Keycloak JWT (Bearer token).
    Login, signup, and logout are handled by Keycloak (OIDC); the client obtains a token and sends it in the Authorization header.

    **Security:** Every protected endpoint enforces authentication and user-scoped access (user_id from token).
    **GDPR:** Data export (Art. 20) and account/data deletion (Art. 17) are audit-logged; no PII in audit logs.
  version: 1.0.0
  contact:
    name: Case Chronicles

servers:
  - url: /api
    description: API base path (e.g. behind same-origin or reverse proxy)

security:
  - bearerAuth: []

tags:
  - name: Cases
    description: Case CRUD and listing
  - name: Contacts
    description: Contact management
  - name: Events
    description: Event timeline
  - name: Emails
    description: Email inbox and assignment
  - name: Categories
    description: User categories
  - name: Documents
    description: File upload/download per case
  - name: Sharing
    description: Share case with users and permissions
  - name: Invites
    description: Pending share invites (by email)
  - name: Me
    description: Current user profile and GDPR (export, delete)
  - name: Billing
    description: Subscription and checkout (placeholder)
  - name: Public
    description: Unauthenticated access (e.g. public case by code)

paths:
  # ---------- Cases ----------
  /cases:
    get:
      tags: [Cases]
      summary: List all cases
      description: Returns cases for the authenticated user. Enforces user_id scoping.
      operationId: fetchAllCases
      security: [{ bearerAuth: [] }]
      responses:
        "200":
          description: List of cases
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Case" }
    post:
      tags: [Cases]
      summary: Create a case
      description: "Creates a new case. user_id is set from the authenticated user. Audit: data_create."
      operationId: createNewCase
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CreateCaseInput" }
      responses:
        "201":
          description: Created case
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Case" }
        "401":
          $ref: "#/components/responses/Unauthorized"

  /cases/by-status/{status}:
    get:
      tags: [Cases]
      summary: List cases by status
      operationId: fetchCasesByStatus
      security: [{ bearerAuth: [] }]
      parameters:
        - name: status
          in: path
          required: true
          schema: { type: string, enum: [active, pending, closed] }
      responses:
        "200":
          description: List of cases
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Case" }

  /cases/shared:
    get:
      tags: [Cases]
      summary: List shared cases
      description: Cases shared with the authenticated user.
      operationId: fetchSharedCases
      security: [{ bearerAuth: [] }]
      responses:
        "200":
          description: List of cases shared with the user
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Case" }

  /cases/{caseId}:
    get:
      tags: [Cases]
      summary: Get case with details
      description: Returns case with related emails and events. Enforces ownership or shared access.
      operationId: fetchCaseWithDetails
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: "#/components/parameters/caseId"
      responses:
        "200":
          description: Case with emails and events
          content:
            application/json:
              schema: { $ref: "#/components/schemas/CaseWithRelations" }
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
    patch:
      tags: [Cases]
      summary: Update case
      operationId: updateCaseDetails
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: "#/components/parameters/caseId"
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CaseUpdateInput" }
      responses:
        "200":
          description: Updated case
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Case" }
        "403":
          $ref: "#/components/responses/Forbidden"
    delete:
      tags: [Cases]
      summary: Delete case
      description: "Audit: data_deletion."
      operationId: removeCase
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: "#/components/parameters/caseId"
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema: { type: boolean }
        "403":
          $ref: "#/components/responses/Forbidden"

  # ---------- Contacts ----------
  /contacts:
    get:
      tags: [Contacts]
      summary: List all contacts
      operationId: fetchAllContacts
      security: [{ bearerAuth: [] }]
      responses:
        "200":
          description: List of contacts
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Contact" }
    post:
      tags: [Contacts]
      summary: Create contact
      operationId: createContact
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CreateContactInput" }
      responses:
        "201":
          description: Created contact
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Contact" }

  /contacts/by-case/{caseId}:
    get:
      tags: [Contacts]
      summary: List contacts by case
      operationId: fetchContactsByCase
      security: [{ bearerAuth: [] }]
      parameters:
        - name: caseId
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        "200":
          description: List of contacts for the case
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Contact" }

  /contacts/{contactId}:
    delete:
      tags: [Contacts]
      summary: Delete contact
      description: "Audit: data_deletion."
      operationId: removeContact
      security: [{ bearerAuth: [] }]
      parameters:
        - name: contactId
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema: { type: boolean }
        "403":
          $ref: "#/components/responses/Forbidden"

  # ---------- Events ----------
  /events:
    get:
      tags: [Events]
      summary: List all events
      operationId: fetchAllEvents
      security: [{ bearerAuth: [] }]
      responses:
        "200":
          description: List of events
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Event" }
    post:
      tags: [Events]
      summary: Create event
      operationId: createNewEvent
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CreateEventInput" }
      responses:
        "201":
          description: Created event
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Event" }

  /events/by-case/{caseId}:
    get:
      tags: [Events]
      summary: List events by case
      operationId: fetchEventsByCase
      security: [{ bearerAuth: [] }]
      parameters:
        - name: caseId
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        "200":
          description: List of events for the case
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Event" }

  /events/{eventId}:
    patch:
      tags: [Events]
      summary: Update event
      operationId: updateEvent
      security: [{ bearerAuth: [] }]
      parameters:
        - name: eventId
          in: path
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/EventUpdateInput" }
      responses:
        "200":
          description: Updated event
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Event" }
        "403":
          $ref: "#/components/responses/Forbidden"
    delete:
      tags: [Events]
      summary: Delete event
      description: "Audit: data_deletion."
      operationId: removeEvent
      security: [{ bearerAuth: [] }]
      parameters:
        - name: eventId
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema: { type: boolean }
        "403":
          $ref: "#/components/responses/Forbidden"

  /events/{eventId}/assign-contact:
    post:
      tags: [Events]
      summary: Assign contact to event
      operationId: assignContactToEvent
      security: [{ bearerAuth: [] }]
      parameters:
        - name: eventId
          in: path
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                contactId: { type: string, format: uuid, nullable: true }
      responses:
        "200":
          description: Updated event
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Event" }
  /events/{eventId}/assign-category:
    post:
      tags: [Events]
      summary: Assign category to event
      operationId: assignCategoryToEvent
      security: [{ bearerAuth: [] }]
      parameters:
        - name: eventId
          in: path
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                categoryId: { type: string, format: uuid, nullable: true }
      responses:
        "200":
          description: Updated event
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Event" }

  # ---------- Emails ----------
  /emails:
    get:
      tags: [Emails]
      summary: List all emails
      operationId: fetchAllEmails
      security: [{ bearerAuth: [] }]
      responses:
        "200":
          description: List of emails
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Email" }
    post:
      tags: [Emails]
      summary: Create email (optionally with attachments)
      description: "Use multipart/form-data for file uploads. Audit: data_create."
      operationId: createNewEmail
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CreateEmailInput" }
          multipart/form-data:
            schema:
              type: object
              properties:
                email: { $ref: "#/components/schemas/CreateEmailInput" }
                files: { type: array, items: { type: string, format: binary } }
      responses:
        "201":
          description: Created email
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Email" }

  /emails/unassigned:
    get:
      tags: [Emails]
      summary: List unassigned emails
      operationId: fetchUnassignedEmails
      security: [{ bearerAuth: [] }]
      responses:
        "200":
          description: Emails not assigned to any case
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Email" }

  /emails/by-case/{caseId}:
    get:
      tags: [Emails]
      summary: List emails by case
      operationId: fetchEmailsByCase
      security: [{ bearerAuth: [] }]
      parameters:
        - name: caseId
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        "200":
          description: List of emails for the case
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Email" }

  /emails/{emailId}:
    patch:
      tags: [Emails]
      summary: Update email
      operationId: updateEmail
      security: [{ bearerAuth: [] }]
      parameters:
        - name: emailId
          in: path
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/EmailUpdateInput" }
      responses:
        "200":
          description: Updated email
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Email" }
        "403":
          $ref: "#/components/responses/Forbidden"
    delete:
      tags: [Emails]
      summary: Delete email
      description: "Audit: data_deletion."
      operationId: removeEmail
      security: [{ bearerAuth: [] }]
      parameters:
        - name: emailId
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema: { type: boolean }
        "403":
          $ref: "#/components/responses/Forbidden"

  /emails/{emailId}/assign-case:
    post:
      tags: [Emails]
      summary: Assign email to case
      operationId: assignEmailToCase
      security: [{ bearerAuth: [] }]
      parameters:
        - name: emailId
          in: path
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [caseId]
              properties:
                caseId: { type: string, format: uuid }
      responses:
        "200":
          description: Updated email
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Email" }
  /emails/{emailId}/assign-contact:
    post:
      tags: [Emails]
      summary: Assign contact to email
      operationId: assignContactToEmail
      security: [{ bearerAuth: [] }]
      parameters:
        - name: emailId
          in: path
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                contactId: { type: string, format: uuid, nullable: true }
      responses:
        "200":
          description: Updated email
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Email" }
  /emails/{emailId}/assign-category:
    post:
      tags: [Emails]
      summary: Assign category to email
      operationId: assignCategoryToEmail
      security: [{ bearerAuth: [] }]
      parameters:
        - name: emailId
          in: path
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                categoryId: { type: string, format: uuid, nullable: true }
      responses:
        "200":
          description: Updated email
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Email" }

  # ---------- Categories ----------
  /categories:
    get:
      tags: [Categories]
      summary: List all categories
      operationId: fetchAllCategories
      security: [{ bearerAuth: [] }]
      responses:
        "200":
          description: List of categories
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Category" }
    post:
      tags: [Categories]
      summary: Create category
      operationId: createCategory
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CreateCategoryInput" }
      responses:
        "201":
          description: Created category
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Category" }

  /categories/{categoryId}:
    patch:
      tags: [Categories]
      summary: Update category
      operationId: updateCategory
      security: [{ bearerAuth: [] }]
      parameters:
        - name: categoryId
          in: path
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CategoryUpdateInput" }
      responses:
        "200":
          description: Updated category
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Category" }
        "403":
          $ref: "#/components/responses/Forbidden"
    delete:
      tags: [Categories]
      summary: Delete category
      operationId: removeCategory
      security: [{ bearerAuth: [] }]
      parameters:
        - name: categoryId
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema: { type: boolean }
        "403":
          $ref: "#/components/responses/Forbidden"

  # ---------- Documents ----------
  /cases/{caseId}/documents:
    get:
      tags: [Documents]
      summary: List documents for a case
      operationId: fetchDocumentsByCase
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: "#/components/parameters/caseId"
      responses:
        "200":
          description: List of documents
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/CaseDocument" }
        "403":
          $ref: "#/components/responses/Forbidden"
    post:
      tags: [Documents]
      summary: Upload document to case
      description: "Multipart form with file. Audit: file_upload."
      operationId: uploadDocumentToCase
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: "#/components/parameters/caseId"
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file: { type: string, format: binary }
      responses:
        "201":
          description: Created document metadata
          content:
            application/json:
              schema: { $ref: "#/components/schemas/CaseDocument" }
        "403":
          $ref: "#/components/responses/Forbidden"

  /documents/{documentId}:
    get:
      tags: [Documents]
      summary: Download document
      description: "Returns file content or redirect. Enforce ownership or shared access. Audit: file_download."
      operationId: downloadDocument
      security: [{ bearerAuth: [] }]
      parameters:
        - name: documentId
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        "200":
          description: File content
          content:
            application/octet-stream:
              schema: { type: string, format: binary }
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
    delete:
      tags: [Documents]
      summary: Delete document
      description: "Audit: data_deletion."
      operationId: removeDocument
      security: [{ bearerAuth: [] }]
      parameters:
        - name: documentId
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema: { type: boolean }
        "403":
          $ref: "#/components/responses/Forbidden"

  # ---------- Sharing ----------
  /cases/{caseId}/share:
    post:
      tags: [Sharing]
      summary: Share case with user
      description: "Share by email. If user has no account, a pending invite is created. Audit: permission_change."
      operationId: shareCaseWithUser
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: "#/components/parameters/caseId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [userEmail]
              properties:
                userEmail: { type: string, format: email }
                can_view: { type: boolean, default: true }
                can_edit: { type: boolean, default: false }
      responses:
        "200":
          description: Share result or invite link
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ShareResult" }
        "403":
          $ref: "#/components/responses/Forbidden"
    get:
      tags: [Sharing]
      summary: List users with access
      operationId: getSharedUsers
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: "#/components/parameters/caseId"
      responses:
        "200":
          description: List of shared users and permissions
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/SharedUser" }
        "403":
          $ref: "#/components/responses/Forbidden"
    delete:
      tags: [Sharing]
      summary: Unshare case (remove one user)
      description: "Audit: permission_change."
      operationId: unshareCase
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: "#/components/parameters/caseId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [sharedWithUserId]
              properties:
                sharedWithUserId: { type: string, format: uuid }
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema: { type: boolean }
        "403":
          $ref: "#/components/responses/Forbidden"
    patch:
      tags: [Sharing]
      summary: Update permissions for a shared user
      description: "Audit: permission_change."
      operationId: updatePermissions
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: "#/components/parameters/caseId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [sharedWithUserId, can_view, can_edit]
              properties:
                sharedWithUserId: { type: string, format: uuid }
                can_view: { type: boolean }
                can_edit: { type: boolean }
      responses:
        "200":
          description: Updated share
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ShareResult" }
        "403":
          $ref: "#/components/responses/Forbidden"

  # ---------- Invites ----------
  /cases/{caseId}/invites:
    get:
      tags: [Invites]
      summary: List pending invites for case
      operationId: getPendingInvites
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: "#/components/parameters/caseId"
      responses:
        "200":
          description: List of pending invites
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Invite" }
        "403":
          $ref: "#/components/responses/Forbidden"
    post:
      tags: [Invites]
      summary: Create invite by email
      description: "Audit: permission_change (invite_sent)."
      operationId: createInvite
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: "#/components/parameters/caseId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, can_view, can_edit]
              properties:
                email: { type: string, format: email }
                can_view: { type: boolean }
                can_edit: { type: boolean }
      responses:
        "200":
          description: Invite created (invite link returned)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/InviteResult" }
        "403":
          $ref: "#/components/responses/Forbidden"
    delete:
      tags: [Invites]
      summary: Cancel invite
      description: "Audit: permission_change (invite_cancelled)."
      operationId: cancelInvite
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: "#/components/parameters/caseId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [inviteId]
              properties:
                inviteId: { type: string, format: uuid }
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema: { type: boolean }
        "403":
          $ref: "#/components/responses/Forbidden"

  /invites/by-token/{token}:
    get:
      tags: [Invites, Public]
      summary: Get invite by token (public)
      description: No auth required. Token is the secret for preview.
      operationId: getInviteByToken
      security: []
      parameters:
        - name: token
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Invite details (case title, permissions, etc.)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Invite" }
        "404":
          $ref: "#/components/responses/NotFound"

  /invites/redeem:
    post:
      tags: [Invites]
      summary: Redeem invite (accept share)
      description: "Requires auth. Audit: permission_change (invite_redeemed)."
      operationId: redeemInvite
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [token]
              properties:
                token: { type: string }
      responses:
        "200":
          description: Success (case shared with user)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/InviteResult" }
        "403":
          $ref: "#/components/responses/Forbidden"

  # ---------- Me (profile & GDPR) ----------
  /me:
    get:
      tags: [Me]
      summary: Get current user profile
      description: Returns profile for the authenticated user (from token + profile table).
      operationId: getCurrentProfile
      security: [{ bearerAuth: [] }]
      responses:
        "200":
          description: User profile
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Profile" }
        "401":
          $ref: "#/components/responses/Unauthorized"
    patch:
      tags: [Me]
      summary: Update profile
      operationId: updateProfile
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ProfileUpdateInput" }
      responses:
        "200":
          description: Updated profile
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Profile" }

  /me/export:
    get:
      tags: [Me]
      summary: Export all my data (GDPR Art. 20)
      description: |
        Data portability. Returns all user data (profile, cases, emails, events, contacts, categories, documents metadata).
        Audit: data_export. No PII in audit log.
      operationId: exportUserData
      security: [{ bearerAuth: [] }]
      parameters:
        - name: format
          in: query
          schema: { type: string, enum: [json, text], default: json }
      responses:
        "200":
          description: Export payload (JSON or plain text)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ExportPayload" }
            text/plain:
              schema: { type: string }
        "401":
          $ref: "#/components/responses/Unauthorized"

  /me/delete:
    post:
      tags: [Me]
      summary: Delete my account and all data (GDPR Art. 17)
      description: |
        Right to erasure. Deletes or anonymizes user and all related data. Audit: data_deletion. No PII in audit log.
      operationId: deleteAccount
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                confirm: { type: boolean, description: "Must be true to confirm" }
      responses:
        "200":
          description: Account and data deleted
        "401":
          $ref: "#/components/responses/Unauthorized"

  # ---------- Billing (placeholder) ----------
  /billing/subscription:
    get:
      tags: [Billing]
      summary: Get current subscription
      operationId: getSubscription
      security: [{ bearerAuth: [] }]
      responses:
        "200":
          description: Subscription info
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SubscriptionInfo" }

  /billing/checkout-url:
    post:
      tags: [Billing]
      summary: Get checkout URL for plan
      operationId: getCheckoutUrl
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                planId: { type: string }
      responses:
        "200":
          description: Checkout URL or error
          content:
            application/json:
              schema:
                type: object
                properties:
                  url: { type: string, nullable: true }
                  error: { type: string, nullable: true }

  /billing/portal-url:
    get:
      tags: [Billing]
      summary: Get customer portal URL
      operationId: getPortalUrl
      security: [{ bearerAuth: [] }]
      responses:
        "200":
          description: Portal URL or error
          content:
            application/json:
              schema:
                type: object
                properties:
                  url: { type: string, nullable: true }
                  error: { type: string, nullable: true }

  # ---------- Public ----------
  /public/cases/by-code/{code}:
    get:
      tags: [Public]
      summary: Get case by access code (public)
      description: No auth. Used for sharing a case via a public link/code.
      operationId: fetchPublicCase
      security: []
      parameters:
        - name: code
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Case with relations (if code valid)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/CaseWithRelations" }
        "404":
          $ref: "#/components/responses/NotFound"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Keycloak access token. Validate signature, issuer, audience, expiry; use sub as user_id.

  parameters:
    caseId:
      name: caseId
      in: path
      required: true
      schema: { type: string, format: uuid }
      description: Case UUID

  responses:
    Unauthorized:
      description: Missing or invalid token
      content:
        application/json:
          schema: { $ref: "#/components/schemas/Error" }
    Forbidden:
      description: Not authorized for this resource (ownership or role)
      content:
        application/json:
          schema: { $ref: "#/components/schemas/Error" }
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema: { $ref: "#/components/schemas/Error" }

  schemas:
    Error:
      type: object
      properties:
        error: { type: string }
        message: { type: string }

    Case:
      type: object
      properties:
        id: { type: string, format: uuid }
        title: { type: string }
        number: { type: string, nullable: true }
        client: { type: string, nullable: true }
        status: { type: string, enum: [active, pending, closed] }
        user_id: { type: string, format: uuid }
        date_created: { type: string, format: date-time, nullable: true }
        created_at: { type: string, format: date-time, nullable: true }
        updated_at: { type: string, format: date-time, nullable: true }

    CaseWithRelations:
      allOf:
        - { $ref: "#/components/schemas/Case" }
        - type: object
          properties:
            emails: { type: array, items: { $ref: "#/components/schemas/Email" } }
            events: { type: array, items: { $ref: "#/components/schemas/Event" } }

    CreateCaseInput:
      type: object
      required: [title, status]
      properties:
        title: { type: string }
        number: { type: string, nullable: true }
        client: { type: string, nullable: true }
        status: { type: string, enum: [active, pending, closed] }

    CaseUpdateInput:
      type: object
      properties:
        title: { type: string }
        number: { type: string, nullable: true }
        client: { type: string, nullable: true }
        status: { type: string, enum: [active, pending, closed] }

    Contact:
      type: object
      properties:
        id: { type: string, format: uuid }
        case_id: { type: string, format: uuid }
        name: { type: string }
        email: { type: string, nullable: true }
        phone: { type: string, nullable: true }
        role: { type: string, nullable: true }
        user_id: { type: string, format: uuid }
        created_at: { type: string, format: date-time, nullable: true }
        updated_at: { type: string, format: date-time, nullable: true }

    CreateContactInput:
      type: object
      required: [case_id, name]
      properties:
        case_id: { type: string, format: uuid }
        name: { type: string }
        email: { type: string, nullable: true }
        phone: { type: string, nullable: true }
        role: { type: string, nullable: true }

    Event:
      type: object
      properties:
        id: { type: string, format: uuid }
        case_id: { type: string, format: uuid }
        title: { type: string }
        description: { type: string, nullable: true }
        event_type: { type: string, nullable: true }
        date: { type: string, nullable: true }
        time: { type: string, nullable: true }
        user_id: { type: string, format: uuid }
        contact_id: { type: string, format: uuid, nullable: true }
        category_id: { type: string, format: uuid, nullable: true }
        created_at: { type: string, format: date-time, nullable: true }
        updated_at: { type: string, format: date-time, nullable: true }

    CreateEventInput:
      type: object
      required: [case_id, title, event_type, date, time]
      properties:
        case_id: { type: string, format: uuid }
        title: { type: string }
        description: { type: string, nullable: true }
        event_type: { type: string }
        date: { type: string }
        time: { type: string }

    EventUpdateInput:
      type: object
      properties:
        title: { type: string }
        description: { type: string, nullable: true }
        event_type: { type: string, nullable: true }
        date: { type: string, nullable: true }
        time: { type: string, nullable: true }
        contact_id: { type: string, format: uuid, nullable: true }
        category_id: { type: string, format: uuid, nullable: true }

    Email:
      type: object
      properties:
        id: { type: string, format: uuid }
        case_id: { type: string, format: uuid, nullable: true }
        sender: { type: string, nullable: true }
        recipient: { type: string, nullable: true }
        subject: { type: string, nullable: true }
        content: { type: string, nullable: true }
        date: { type: string, nullable: true }
        time: { type: string, nullable: true }
        user_id: { type: string, format: uuid }
        contact_id: { type: string, format: uuid, nullable: true }
        category_id: { type: string, format: uuid, nullable: true }
        attachments: { type: array, items: { $ref: "#/components/schemas/EmailAttachment" }, nullable: true }
        created_at: { type: string, format: date-time, nullable: true }
        updated_at: { type: string, format: date-time, nullable: true }

    EmailAttachment:
      type: object
      properties:
        id: { type: string }
        filename: { type: string }
        type: { type: string }
        url: { type: string }
        path: { type: string, nullable: true }
        size: { type: number, nullable: true }

    CreateEmailInput:
      type: object
      required: [case_id, sender, subject, content, date, time]
      properties:
        case_id: { type: string, format: uuid }
        sender: { type: string }
        recipient: { type: string, nullable: true }
        subject: { type: string }
        content: { type: string }
        date: { type: string }
        time: { type: string }
        attachments: { type: array, items: { $ref: "#/components/schemas/EmailAttachment" }, nullable: true }

    EmailUpdateInput:
      type: object
      properties:
        case_id: { type: string, format: uuid, nullable: true }
        sender: { type: string, nullable: true }
        recipient: { type: string, nullable: true }
        subject: { type: string, nullable: true }
        content: { type: string, nullable: true }
        date: { type: string, nullable: true }
        time: { type: string, nullable: true }
        contact_id: { type: string, format: uuid, nullable: true }
        category_id: { type: string, format: uuid, nullable: true }

    Category:
      type: object
      properties:
        id: { type: string, format: uuid }
        name: { type: string }
        color: { type: string, nullable: true }
        user_id: { type: string, format: uuid }
        created_at: { type: string, format: date-time, nullable: true }
        updated_at: { type: string, format: date-time, nullable: true }

    CreateCategoryInput:
      type: object
      required: [name]
      properties:
        name: { type: string }
        color: { type: string, nullable: true }

    CategoryUpdateInput:
      type: object
      properties:
        name: { type: string }
        color: { type: string, nullable: true }

    CaseDocument:
      type: object
      properties:
        id: { type: string, format: uuid }
        case_id: { type: string, format: uuid }
        filename: { type: string }
        type: { type: string }
        url: { type: string }
        size: { type: number, nullable: true }
        uploaded_at: { type: string, format: date-time }
        user_id: { type: string, format: uuid }

    Profile:
      type: object
      properties:
        id: { type: string, format: uuid }
        user_id: { type: string, format: uuid }
        email: { type: string, nullable: true }
        first_name: { type: string, nullable: true }
        last_name: { type: string, nullable: true }
        business_model: { type: string, enum: [individual, business], nullable: true }
        created_at: { type: string, format: date-time, nullable: true }
        updated_at: { type: string, format: date-time, nullable: true }

    ProfileUpdateInput:
      type: object
      properties:
        email: { type: string, nullable: true }
        first_name: { type: string, nullable: true }
        last_name: { type: string, nullable: true }
        business_model: { type: string, enum: [individual, business], nullable: true }

    ExportPayload:
      type: object
      description: "GDPR Art. 20 - Data portability export"
      properties:
        exported_at: { type: string, format: date-time }
        user_id: { type: string, format: uuid }
        profile: { $ref: "#/components/schemas/Profile", nullable: true }
        cases: { type: array, items: { $ref: "#/components/schemas/Case" } }
        emails: { type: array, items: { $ref: "#/components/schemas/Email" } }
        events: { type: array, items: { $ref: "#/components/schemas/Event" } }
        contacts: { type: array, items: { $ref: "#/components/schemas/Contact" } }
        categories: { type: array, items: { $ref: "#/components/schemas/Category" } }
        documents: { type: array, items: { $ref: "#/components/schemas/CaseDocument" } }

    ShareResult:
      type: object
      properties:
        success: { type: boolean }
        inviteLink: { type: string, nullable: true }
        pending: { type: boolean, nullable: true }
        error: { type: string, nullable: true }

    SharedUser:
      type: object
      properties:
        user_id: { type: string, format: uuid }
        email: { type: string, nullable: true }
        can_view: { type: boolean }
        can_edit: { type: boolean }

    Invite:
      type: object
      properties:
        id: { type: string, format: uuid }
        case_id: { type: string, format: uuid }
        email: { type: string }
        token: { type: string }
        can_view: { type: boolean }
        can_edit: { type: boolean }
        expires_at: { type: string, format: date-time, nullable: true }
        created_at: { type: string, format: date-time, nullable: true }

    InviteResult:
      type: object
      properties:
        success: { type: boolean }
        inviteLink: { type: string, nullable: true }
        caseId: { type: string, format: uuid, nullable: true }
        error: { type: string, nullable: true }

    SubscriptionInfo:
      type: object
      description: "Placeholder until payment provider (e.g. Stripe) is configured"
      properties:
        plan: { type: string, nullable: true }
        status: { type: string, nullable: true }
        current_period_end: { type: string, format: date-time, nullable: true }
